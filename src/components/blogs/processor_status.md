# 处理器状态（操作系统）

*posted by yaoyanhuo on 2019-02-12*

> 处理器状态至少有两种：内核态（管态）和用户态（目态）。有些操作系统会设置三种或三种以上的状态。内核状态可以执行所有指令，用户态只能执行非特权指令。程序状态字会记录程序运行的各种状态，以便保存和恢复程序现场。


## 机器指令执行过程

计算机的基本功能是执行程序，最终被执行的是存储在内存中的机器指令代码。每台计算机的机器指令集合统称指令系统，反应计算机的功能和处理能力。为了实现指令功能，处理器中设置了一组寄存器用作寻址或存放数据、变量和中间结果。

![处理器调度.png](http://img.yaoyanhuo.com/%E5%A4%84%E7%90%86%E5%99%A8%E8%B0%83%E5%BA%A6.png)

程序以**进程**的形式来占用处理器和系统资源。处理器调度（进程调度）就是控制和协调进程对处理器的竞争。

![指令执行过程.png](http://img.yaoyanhuo.com/%E6%8C%87%E4%BB%A4%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.png)

处理器从程序计数器处拿到下一个指令的地址，通过该地址再从内存中的机器指令代码集合中取得具体指令放入指令寄存器，然后译码执行，程序计数器将自动增长或变为转移地址以指明下一条待执行指令的地址。

## 特权指令和非特权指令

**特权指令**是指只能在内核态下使用的指令，这些指令涉及改变机器状态、修改寄存器内容、启动设备I/O等，这些指令的执行不仅影响运行程序自身，而且干扰其他程序。

**非特权指令**是指在目态和管态下都能使用的指令。

操作系统程序能够执行全部机器指令，应用程序只能使用非特权指令。由于应用程序在执行有关资源管理的机器指令时易于导致混乱，造成系统或用户信息被破坏。因此，在多道程序设计环境中，从资源管理和控制程序执行角度出发，必须把指令系统中的指令分成两类：特权指令和非特权指令。

试想，如果任何指令都操作修改机器状态，A 打印机要使用机器，B 执行程序要暂停，C 网络监控要求立即执行，这时候，机器应该听谁的呢？执行什么呢？这还只是三个指令，如果更多指令出现，是不是机器该直接蒙圈罢工了？好比一家公司的资金，普通员工只能申请使用，而实际决定如何分配的是更高层的管理者。


## 处理器状态

计算机系统处理器中的运行程序分为两大类：系统程序和应用程序。系统程序控制应用程序，且有权管理和分配资源，应用程序只能申请使用资源。根据执行程序对资源和机器指令的使用权限，可将处理器设置成不同的状态，程序状态字中会有一位处理器硬件标志位，也叫处理器状态位，用于标记处理器当前状态。

处理器状态至少有两种：内核态（管态）和用户态（目态）。有些操作系统会设置三种或三种以上的状态。处于内核态的处理器可以执行所有指令，访问所有内存单元和系统资源，甚至可以改变处理器状态（加载程序状态字可将处理器状态更为用户态）。用户态的处理器就不能执行特权指令了，也只能访问程序所在的地址空间，这样可以防止操作系统程序收到应用程序的侵害。好比仓库，如果阿猫阿狗都能开仓取货，那还有何安全可言。

**用户态向内核态转换触发条件**

  - 程序请求操作系统服务，执行系统调用
  - 程序运行时产生中断事件，运行程序被中断（如 I/O 操作完成），转向中断处理程序处理
  - 程序运行时产生异常事件，运行程序被中断（如 程序性中断），转向异常处理程序处理

三种途径都是通过中断机制发生，可说中断和异常是用户态转内核态的仅有途径。

**内核态转为用户态触发条件**

  - 通过执行 加载程序状态字特权指令 将内核态更为用户态


## 用户栈和核心栈

**用户栈**是用户进程空间开辟的一块区域，用于保存应用程序的子程序（函数）间相互调用的参数、返回值、返回点以及子程序的局部变量。

**核心栈**也叫系统栈或内核栈，是内存中属于操作系统空间的一块区域。用途包括两方面：
1. 保护中断现场，对于嵌套中断，被中断程序的现场信息依次压入核心栈，中断返回时逆序弹出；
2. 保存操作系统程序（函数）间互相调用的参数、返回值、返回点以及程序局部变量。

**每个进程被创建都会被分配一个核心栈和一个用户栈**。核心栈可读可写不可执行，大小一般有限制， Linux 系统中为 8 KB。不可执行是因为核心栈里面存放的是断点、现场、变量等信息，不是可执行代码。可执行代码存放于内存中的代码区。此处只讨论栈，关于栈和堆的具体描述参见 [堆和栈的区别](http://www.cnblogs.com/lln7777/archive/2012/03/14/2396164.html)

虽说有两个栈，但硬件栈指针只有一个，随着处理器状态转换。内核态，指向核心栈；用户态，指向用户栈。

## 程序状态字

操作系统将程序运行时的一组动态信息汇集在一起，称为**程序状态字**（Program Status Word, PSW），并存放在处理器的一组特殊寄存器里，以方便系统控制和管理。动态信息包括处理器状态位、下一条指令地址等。

在 Interl x86 机器中，PSW 由标志寄存器 EFLAGS 和 指令寄存器 EIP 组成。前者记录当前处理器状态、程序执行结果和系统模式，后者记录下一条指令相对于当前代码片段起始位置的偏移量。从 PSW 存储的动态信息来看，主要用来指示运行程序状态，控制指令执行顺序，并保留和指示与运行程序有关的各种信息，主要作用是实现程序状态的保护和恢复。

每个正在执行的程序都有一个与其当前运行状态相关的PSW，而每个处理器都设置一个硬件PSW寄存器，一个程序占用处理器执行时，PSW占用硬件PSW寄存器。多数计算机处理器现场可能没有具体的 PSW 寄存器，但总会有一组寄存器起到类似的作用。


## 参考文献

《操作系统教程》第 5 版 . 费翔林 骆斌 . 编著，在回顾阅读过程中同时咨询操作系统老师（贾小林）