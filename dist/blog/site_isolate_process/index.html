<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.jpg"><title>yaoyanhuo</title><link href="/css/router.f5a5336d.css" rel="prefetch"><link href="/js/router.7db9e200.js" rel="prefetch"><link href="/css/app.3ec86574.css" rel="preload" as="style"><link href="/js/app.e6b83662.js" rel="preload" as="script"><link href="/js/chunk-vendors.feddb447.js" rel="preload" as="script"><link href="/css/app.3ec86574.css" rel="stylesheet"><link rel="stylesheet" type="text/css" href="/css/router.f5a5336d.css"><script charset="utf-8" src="/js/router.7db9e200.js"></script></head><body><noscript><strong>We're sorry but yaoyanhuo doesn't work properly without JavaScript enabled. Please enable it to continue.</strong></noscript><div id="app"><div class="head"><div class="head-inner g_page-container"><a href="/" class="router-link-active"><img src="/img/head.jpg"></a><div class="info"><h1 class="name">妖艳货的个人空间</h1><span> Be a simple programmer </span></div></div></div><div><div class="blog-detail g_page-container"><div class="markdown-body"><div class="markdown-to-vue-loader"><h1 id="站点隔离技术中的进程实现（site-isolation）">站点隔离技术中的进程实现（Site Isolation）</h1><p><em>posted by yaoyanhuo on 2019-04-02</em></p><blockquote><p>Site Isolation 是 Chrome 67 之后默认开启的一项技术实现，采用了“一个站点一个进程”的实现模式。没有使用这项技术的浏览器依旧是一个标签页一个进程的方式。本文将以问答实验的形式对进程表现进行详细的探讨，属于实验性内容，图片较多，注意在 WI-FI 环境下浏览，土豪流量随意。</p></blockquote><h2 id="总述">总述</h2><p>实现了 Site Isolation 的浏览器根据站点分配进程，一个站点一个进程；而普通浏览器是根据标签页进行分配，多一个标签多一个进程，无论是否是同一站点同一URL。</p><h2 id="探索目录">探索目录</h2><h4 id="1-两个-url-一模一样的标签页运行在两个不同的进程中吗？">1. 两个 URL 一模一样的标签页运行在两个不同的进程中吗？</h4><p>  普通浏览器会产生两个进程，支持 Site Isolation 的浏览器只会产生一个。</p><h4 id="2-支持-site-isolation-的浏览器中，不同的域名、子域名、端口号会对进程有什么影响？">2. 支持 Site Isolation 的浏览器中，不同的域名、子域名、端口号会对进程有什么影响？</h4><p>  只要一级域名相同就共享同一个进程，一级域名不同，则不共享进程。</p><h4 id="3-源站点页面中嵌入跨域站点的-iframe-会产生新的进程吗？">3. 源站点页面中嵌入跨域站点的 iframe 会产生新的进程吗？</h4><p>  普通浏览器跨域站点和源站共享内存; 支持 Site Isolation 的浏览器会产生新的进程。</p><h4 id="4-源站点页面中嵌入-一级域名相同-而子域名和端口号不同-站点的-iframe-时，会产生新的进程吗？">4. 源站点页面中嵌入 一级域名相同 而子域名和端口号不同 站点的 iframe 时，会产生新的进程吗？</h4><p>  不会。</p><h2 id="环境准备">环境准备</h2><p>host 配置</p><pre><code>127.0.0.1 a.dd.com
127.0.0.1 c.dd.com
127.0.0.1 test.pp.com
127.0.0.1 bcc.qq.com
127.0.0.1 sheepluo.cap.qq.com</code></pre><p>浏览器：Chrome 73、Firefox 66、IE11</p><p>服务端代码片段示例，</p><pre><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">3002</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>greeting<span class="token punctuation">:</span> <span class="token string">'hello chrome!'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`app is listening at localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h2 id="1-两个-url-一模一样的标签页运行在两个不同的进程中吗？-1">1 两个 URL 一模一样的标签页运行在两个不同的进程中吗？</h2><p><strong>测试案例</strong>：在各个浏览器打开两个一模一样的标签页，<code>localhost:8000/blog/corb</code></p><p><strong>测试结果</strong>：Firefox 和 IE 这类普通浏览器会生成两个进程（因为开了两个标签页）；应用了 <code>Site Isolation</code> 的 Chrome 高版本浏览器（Chrome 67 以后）只会生成一个进程。如下图所示，</p><p><strong>【Tooltip】<code>shift + ~ + ESC</code> 会自动打开 Chrome 的任务管理器；IE 没有自身的任务管理器，只能查看系统的任务管理器观察。</strong></p><p><img src="http://img.yaoyanhuo.com/blog/chrome_process_detail.png" alt="chrome 相同标签页的进程表现"></p><p><img src="http://img.yaoyanhuo.com/blog/firefox_process.png" alt="Firefox 相同标签页的进程表现"></p><p><img src="http://img.yaoyanhuo.com/blog/IE_process.png" alt="IE 相同标签页的进程表现"></p><h2 id="2-支持-site-isolation-的浏览器中，不同的子域名、端口号会对进程有什么影响？">2 支持 Site Isolation 的浏览器中，不同的子域名、端口号会对进程有什么影响？</h2><p><strong>测试案例</strong>：在浏览器中访问 <code>a.dd.com:3001</code><code>a.dd.com:3002</code><code>c.dd.com:3002</code> 和 <code>sheepluo.cap.qq.com:3002</code></p><p><strong>测试结果</strong>：如下图所示，一级域名相同、子域名和端口号不同的的三个标签页共享一个进程；域名完全不同的 <code>sheepluo.cap.qq.com:3002</code> 独占一个进程。</p><p>对于普通浏览器，进程开启的一般标准是有几个标签页，由此，当前测试结果毫无疑问，开启了 4 个进程。</p><p><img src="http://img.yaoyanhuo.com/blog/different_domain_port_process.png" alt="不同域名端口的进程情况"></p><h2 id="3-源站点页面中嵌入跨域站点的-iframe-会产生新的进程吗？-1">3 源站点页面中嵌入跨域站点的 iframe 会产生新的进程吗？</h2><p><strong>案例</strong>：在 <code>test.pp.com:3002</code> 中嵌入 <code>v.qq.com</code><strong>结果</strong>：Crome 73 产生了新进程，分配了新内存；Firefox 没有产生新进程，跨域站点和源站点共享进程。</p><p>代码片段如下，</p><pre><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>跨域测试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Home Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This is a test project!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">top</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://v.qq.com<span class="token punctuation">"</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></code></pre><p><img src="http://img.yaoyanhuo.com/blog/process_01.png" alt="chrome 嵌入跨站 iframe"></p><p><img src="http://img.yaoyanhuo.com/blog/firefox_iframe_process.png" alt="Firefox 相同标签页的进程表现"></p><h2 id="4-源站点页面中嵌入-一级域名相同-而子域名和端口号不同-站点的-iframe-时，会产生新的进程吗？-1">4 源站点页面中嵌入 一级域名相同 而子域名和端口号不同 站点的 iframe 时，会产生新的进程吗？</h2><p><strong>测试案例</strong>：<code>http://a.dd.com:3002/</code> 中嵌入 <code>http://c.dd.com:3001/</code></p><p><strong>测试结果</strong>：所有浏览器都不会产生新的进程，甚至子进程，直接使用原进程。</p><p>代码片段如下，</p><pre><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>跨域测试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Home Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This is a test project!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">top</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://c.dd.com:3001<span class="token punctuation">"</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></code></pre><p><img src="http://img.yaoyanhuo.com/blog/chrome_iframe_same_domain.png" alt="chrome 嵌入同域名 iframe"><img src="http://img.yaoyanhuo.com/blog/fire_fox_iframe_same_domain.png" alt="firefox 嵌入同域名 iframe"></p></div></div></div></div><footer><a href="http://www.beian.miit.gov.cn" target="_blank">.沪ICP备19007658号. </a>&nbsp;
  <a href="http://www.yaoyanhuo.com">www.yaoyanhuo.com</a>  . Connect me by email yaoyanhuoyi@qq.com
</footer></div><script src="/js/chunk-vendors.feddb447.js"></script><script src="/js/app.e6b83662.js"></script></body></html>